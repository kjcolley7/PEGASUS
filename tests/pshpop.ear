.import "test_suite.ear"

.scope
@test:
	// Push with SP in the middle, make sure it's the value of SP before the push
	MOV     A0, SP
	PSH     {ZERO, SP, DPC}
	INC     SP, 2 // skip pushed ZERO
	POP     {A1}
	CMP     A0, A1
	BPT.NE
	ORR.NE  S2, 1 << 0
	INC     SP, 2 // clean up stack
	
	// Pop including SP, make sure regs get the right values and SP is updated correctly
	MOV     S0, SP
	MOV     A0, 0x1234
	MOV     A1, 0x5678
	MOV     A2, 0x9abc
	MOV     A3, 0xdef0
	PSH     {A0, A1, A2, A3}
	POP     {ZERO, A0, A1, SP}
	CMP     A0, 0x5678
	BPT.NE
	ORR.NE  S2, 1 << 1
	CMP     A1, 0x9abc
	BPT.NE
	ORR.NE  S2, 1 << 2
	CMP     SP, 0xdef0
	BPT.NE
	ORR.NE  S2, 1 << 3
	MOV     SP, S0 // reset SP
	
	RET
